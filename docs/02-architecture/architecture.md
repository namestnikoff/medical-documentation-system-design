# Архитектура системы

## Общее описание

Система построена по **сервисно-ориентированной архитектуре**: компоненты независимы, взаимодействуют через REST API (синхронно) и Apache Kafka (асинхронно), интегрируются с государственными системами (ЕГИСЗ, ЕСИА).

### Ключевые принципы

- **Слабая связанность:** каждый сервис имеет чёткую границу ответственности и собственную схему данных в рамках общего PostgreSQL-кластера
- **Масштабируемость:** stateless-сервисы масштабируются горизонтально; PostgreSQL реплицируется для отказоустойчивости и масштабирования чтения
- **Событийная архитектура:** асинхронные процессы (уведомления, интеграции, аудит) обрабатываются через Kafka для разгрузки и надёжности
- **Соответствие нормативам:** система спроектирована с учётом требований 911н (МИС), 323-ФЗ (охрана здоровья), 152-ФЗ (ПДн), 242-ФЗ (локализация)

---

## Стратегия API

Система предоставляет три типа API для разных сценариев использования:

### 1. REST API
- **Назначение:** CRUD-операции и регуляторно значимые транзакции (создание документов, подписание УКЭП, отправка в ЕГИСЗ)
- **Обоснование:** предсказуемость, трассируемость действий, соответствие требованиям 911н к протоколированию
- **Спецификация:** [OpenAPI 3.0](../04-integration/specs/rest.yaml)

### 2. GraphQL Gateway
- **Назначение:** сложные агрегирующие запросы (карточка пациента с историей визитов и документов, дашборды аналитики)
- **Обоснование:** снижение количества запросов от фронтенда, упрощение разработки UI, гибкость выборки данных
- **Ограничение:** не используется для критичных операций (подписание, передача СЭМД) — только для чтения и аналитики
- **Спецификация:** [GraphQL Schema](../04-integration/specs/schema.graphql)

### 3. Kafka (Async Events)
- **Назначение:** асинхронное взаимодействие между сервисами и внешними системами
- **Примеры событий:** AppointmentScheduled, DocumentCreated, DocumentSigned, EgiszDocumentSent
- **Обоснование:** разгрузка синхронных потоков, масштабируемость обработки, надёжная доставка, возможность повторной обработки
- **Спецификация:** [AsyncAPI (Kafka)](../04-integration/specs/kafka.yaml)

---

## Компонентная структура

![Диаграмма контейнеров](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/namestnikoff/medical-documentation-system-design/main/docs/02-architecture/diagrams/containers.puml)

[Исходный код PlantUML](diagrams/containers.puml)

### Frontend

- **Веб-клиент врача** — рабочее место для ведения приёмов, оформления документов, подписания УКЭП
- **Веб-клиент регистратуры** — запись пациентов, управление расписанием врачей
- **Личный кабинет пациента** — просмотр истории визитов и документов, запись на приём

### API Gateway

- Единая точка входа для всех клиентских приложений
- Маршрутизация запросов к соответствующим backend-сервисам
- Централизованная авторизация (проверка JWT), rate limiting, мониторинг

### Backend-сервисы

| Сервис | Ответственность | Ключевые функции |
|--------|-----------------|------------------|
| **Сервис пациентов** | Управление данными пациентов | CRUD, поиск, ЭМК, история болезни, согласие на обработку ПДн |
| **Сервис врачей и расписаний** | Реестр врачей и планирование | Профили врачей, квалификации, график работы, слоты, проверка доступности, запись на приём |
| **Сервис приёмов** | Ведение медицинских приёмов | Открытие/закрытие визита, осмотр, диагноз (МКБ-10), назначения, связь с пациентом и врачом |
| **Сервис медицинских документов** | Управление СЭМД | Формирование СЭМД (CDA R2), версионность, подписание УКЭП, хранение контрольных сумм, статусы отправки |
| **Сервис пользователей и аутентификации** | Управление учётными записями | CRUD пользователей, роли (RBAC), аутентификация (JWT), интеграция с ЕСИА для пациентов |
| **Сервис платных услуг** | Учёт коммерческих услуг | Прейскурант, выставление счетов, оплата, ДМС, интеграция с платёжными системами |
| **Сервис статистики** | Отчётность и аналитика | Автоматические отчёты по формам Минздрава, выгрузки, агрегация данных по профилям помощи |
| **Сервис аудита** | Логирование действий | Неизменяемый журнал всех операций с ПДн и медицинскими документами (требование 911н), хранение 3+ года |
| **Сервис интеграции с ЕГИСЗ** | Обмен с федеральным хранилищем | Формирование пакетов СЭМД, валидация по XSD, отправка в РЭМД, получение GUID и статусов, обработка ошибок, повторная подача |

### Инфраструктурные компоненты

- **PostgreSQL-кластер** — реляционная СУБД с потоковой репликацией (WAL) для отказоустойчивости и масштабирования чтения; каждый сервис использует собственную схему для изоляции данных
- **Apache Kafka** — брокер сообщений для асинхронных событий и межсервисного взаимодействия
- **OpenSearch / Elasticsearch** — полнотекстовый поиск по содержимому медицинских документов и карточек пациентов

### Внешние системы

- **ЕГИСЗ / РЭМД** — федеральное хранилище структурированных электронных медицинских документов (СЭМД); передача документов в формате CDA R2, получение уникальных идентификаторов (GUID) и статусов обработки
- **ЕСИА (Госуслуги)** — единая система идентификации и аутентификации для пациентов и персонала
- **Федеральные справочники** — МКБ-10 (диагнозы), ФРМО (медицинские организации), ФРМР (медицинские работники), ЖНВЛП (лекарства) для корректного кодирования и обмена данными

---

## Модули и границы ответственности

| Модуль | Ответственность | Примечания |
|--------|-----------------|------------|
| **Пациенты** | CRUD, поиск, история болезни | Хранение ЭМК, согласие на обработку ПДн, связь с ЕГИСЗ (egisz_patient_id) |
| **Врачи** | Реестр врачей, квалификации, профили | Интеграция с ФРМР, хранение данных о сертификатах УКЭП |
| **Расписания и запись** | График работы, слоты, запись на приём | Проверка доступности слотов, уведомления о записи/изменениях |
| **Приёмы** | Ведение приёма, диагноз, назначения | Связь с пациентом, врачом, документами; статусы визита (scheduled/in_progress/completed) |
| **Медицинские документы** | Формирование, подписание, передача СЭМД | Версионность, неизменяемость после подписи, контрольные суммы (SHA-256), статусы ЕГИСЗ |
| **Пользователи и аутентификация** | Роли, аутентификация, ЕСИА | RBAC, JWT-токены, интеграция с ЕСИА для государственной аутентификации |
| **Платные услуги** | Учёт, оплата, ДМС | Прейскурант, счета, интеграция с платёжными шлюзами |
| **Статистика** | Отчёты, аналитика | Автоматизация форм Минздрава, агрегация по профилям помощи |
| **Аудит** | Логирование действий | Неизменяемый журнал (append-only), хранение 3+ года (требование 911н) |
| **Интеграция** | ЕГИСЗ, ЕСИА, федеральные справочники | Формирование/валидация СЭМД, обработка статусов, повторная подача |
| **Kafka / Event Bus** | Асинхронная передача событий | Разгрузка синхронных потоков, надёжная доставка, возможность повторной обработки |

---

## Сквозной сценарий: «Запись и оформление приёма пациента»

Типовой процесс, затрагивающий большинство функциональных модулей системы.

### Шаги процесса

1. **Запись на приём**
   - Пациент через личный кабинет (или регистратор) выбирает врача и время
   - Система проверяет доступность слота в модуле «Расписания»
   - При успехе создаётся запись в модуле «Приёмы», публикуется событие `AppointmentScheduled` в Kafka
   - Асинхронно отправляются уведомления пациенту и врачу (SMS/email)

2. **Приём врача**
   - Врач открывает приём, система загружает ЭМК пациента (история болезни, предыдущие документы)
   - Врач вносит данные осмотра, жалобы, анамнез
   - Врач ставит диагноз (МКБ-10), назначает лечение и исследования
   - Все действия протоколируются в модуле «Аудит»

3. **Формирование СЭМД**
   - Система автоматически генерирует структурированный электронный медицинский документ (СЭМД) в формате CDA Release 2
   - Документ валидируется (структура по XSD-схеме, обязательные поля, коды справочников)
   - Врач просматривает документ в интерфейсе

4. **Подписание электронной подписью (УКЭП)**
   - Врач подписывает документ усиленной квалифицированной электронной подписью (УКЭП)
   - Система проверяет валидность сертификата ЭП
   - Документ становится неизменяемым, сохраняется контрольная сумма (SHA-256) и значение подписи
   - Публикуется событие `DocumentSigned` в Kafka

5. **Отправка в ЕГИСЗ**
   - Модуль интеграции с ЕГИСЗ формирует пакет для передачи в федеральное хранилище РЭМД
   - Документ валидируется перед отправкой (структура, обязательные поля, коды)
   - Отправляется запрос в ЕГИСЗ REST API через защищённый канал (TLS 1.3, взаимная аутентификация сертификатами)
   - **При успехе:**
     - ЕГИСЗ возвращает уникальный идентификатор документа (GUID)
     - Статус документа обновляется: `egisz_status = 'accepted'`, сохраняется `egisz_id`
     - Публикуется событие `EgiszDocumentAccepted`
   - **При ошибке валидации:**
     - Система логирует код ошибки и текстовое описание (поле `egisz_error_message`)
     - Уведомляется врач/КМС о необходимости исправления
     - Документ помещается в Kafka-топик `EgiszDocumentPending` для повторной отправки после исправления
   - **При недоступности ЕГИСЗ:**
     - Документ помещается в очередь повторной отправки с экспоненциальной задержкой (1 мин → 5 мин → 15 мин → 1 час)

6. **Доступность данных**
   - История приёма отображается: врачу — в профиле пациента, пациенту — в личном кабинете или на Госуслугах
   - Данные о приёме и расходах (платные/ОМС) передаются в модули «Платные услуги» и «Статистика»

7. **Аудит и отчётность**
   - Все действия (создание документа, подписание, отправка в ЕГИСЗ, просмотр данных) логируются в неизменяемом журнале аудита согласно требованиям 911н
   - Данные агрегируются модулем «Статистика» для автоматических отчётов по формам Минздрава

### Диаграммы процесса

**BPMN-диаграмма (общий поток):**

![BPMN: Запись на приём](diagrams/patient_appointment_booking.jpg)

[Описание процесса](diagrams/appointment-booking-process.md)

**Sequence-диаграммы (детализация взаимодействий):**

1. **Авторизация пациента**

![Sequence: Авторизация](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/namestnikoff/medical-documentation-system-design/main/docs/02-architecture/diagrams/patient-authentication-detailed.puml)

[Исходный код PlantUML](diagrams/patient-authentication-detailed.puml)

2. **Бронирование записи на приём**

![Sequence: Бронирование](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/namestnikoff/medical-documentation-system-design/main/docs/02-architecture/diagrams/appointment-booking-detailed.puml)

[Исходный код PlantUML](diagrams/appointment-booking-detailed.puml)

---

## Внешние зависимости

### ЕГИСЗ (Единая государственная информационная система в сфере здравоохранения)

- **Назначение:** передача СЭМД в федеральное хранилище РЭМД (Реестр электронных медицинских документов)
- **Формат:** CDA Release 2 (Clinical Document Architecture) с использованием российских справочников
- **Протокол:** SOAP/REST через защищённый канал (TLS 1.3, взаимная аутентификация)
- **Функции:**
  - Отправка подписанных СЭМД после завершения приёма
  - Получение уникального идентификатора ЕГИСЗ (GUID) для каждого документа
  - Мониторинг статусов обработки (pending → sent → accepted/rejected)
  - Обработка ошибок валидации и повторная подача
- **Нормативная база:** Приказ Минздрава 911н, методические рекомендации по обмену СЭМД

### ЕСИА (Единая система идентификации и аутентификации)

- **Назначение:** государственная аутентификация пользователей (пациенты, врачи, администраторы)
- **Протокол:** OAuth 2.0 / OpenID Connect
- **Функции:**
  - Вход пациентов через учётную запись Госуслуг
  - Опционально: аутентификация медицинского персонала (при требовании регулятора)
  - Получение подтверждённых персональных данных (ФИО, СНИЛС, дата рождения)
- **Преимущества:** единая учётная запись, соответствие государственным стандартам, упрощение регистрации пациентов

### Федеральные справочники

- **МКБ-10** (Международная классификация болезней) — кодирование диагнозов
- **ФРМО** (Федеральный реестр медицинских организаций) — идентификация поликлиники
- **ФРМР** (Федеральный реестр медицинских работников) — сопоставление врачей с государственным реестром
- **ЖНВЛП** (Жизненно необходимые и важнейшие лекарственные препараты) — назначение медикаментов

---

## Масштабирование и отказоустойчивость

### Горизонтальное масштабирование

- **Backend-сервисы:** stateless, масштабируются добавлением экземпляров без простоя; балансировка нагрузки через API Gateway или Kubernetes Service
- **Kafka:** кластер из 3+ брокеров с репликацией разделов (replication factor = 3) для надёжности доставки событий
- **PostgreSQL:** масштабирование чтения через потоковую репликацию (WAL); ведомые реплики для read-only запросов

### Отказоустойчивость

- **RTO (Recovery Time Objective):** ≤ 1 час — время восстановления после сбоя
- **RPO (Recovery Point Objective):** ≤ 5 минут — допустимая потеря данных
- **Механизмы:**
  - Автоматический failover PostgreSQL на ведомую реплику при отказе мастера
  - Очередь повторной отправки СЭМД в ЕГИСЗ при недоступности внешнего сервиса (Kafka-топик EgiszDocumentPending)
  - Резервное копирование БД (инкрементальное каждые 15 минут, полное ежедневно), хранение копий минимум 3 года (требование 911н)
  - Мониторинг здоровья сервисов (health checks), алертинг при деградации

### Производительность

- **Целевая нагрузка:** 20 000 приёмов в день (~14 приёмов/мин, пик до 42 приёмов/мин)
- **SLA:** API < 200 ms (95-й процентиль), создание документа ≤ 3 сек, uptime ≥ 99.9%
- **Оптимизация:**
  - Кеширование часто запрашиваемых данных (Redis)
  - Индексы БД для поиска по ФИО, СНИЛС, полису
  - Асинхронная обработка тяжёлых операций (генерация СЭМД, отправка в ЕГИСЗ, уведомления) через Kafka
  - Connection pooling для PostgreSQL

---

## Соответствие нормативным требованиям

- **Приказ Минздрава 911н:** ведение ЭМК, протоколирование действий, резервное копирование (3+ года), контроль целостности (SHA-256, УКЭП)
- **323-ФЗ (Охрана здоровья):** защита врачебной тайны, юридическая значимость ЭП, правовые основы обработки меддокументации
- **152-ФЗ (Персональные данные):** принципы обработки ПДн (законность, минимизация, целенаправленность), согласие пациента, права субъектов данных
- **242-ФЗ (Локализация):** хранение персональных данных российских граждан на территории РФ (PostgreSQL в российских ЦОД)
- **63-ФЗ (Электронная подпись):** использование УКЭП для подписания СЭМД, проверка валидности сертификатов

Подробнее о безопасности и соответствии законодательству см. раздел [05. Безопасность](../05-security/security.md).

---

## Дополнительные материалы

- **Логическая модель данных:** [03. Слой данных](../03-data-layer/data-layer.md)
- **Интеграционный профиль:** [04. Интеграции](../04-integration/integration.md)
  - [REST API (OpenAPI)](../04-integration/specs/rest.yaml)
  - [Async API (Kafka)](../04-integration/specs/kafka.yaml)
  - [GraphQL Schema](../04-integration/specs/schema.graphql)
- **Требования:** [01. Требования](../01-requirements/business-requirements.md)
- **Безопасность:** [05. Безопасность](../05-security/security.md)
