# Интеграционный профиль

## Обзор

Система обеспечивает взаимодействие через **три типа API**: REST (транзакции), GraphQL (агрегирующие запросы), Kafka (асинхронные события). Все внешние интеграции выполняются через защищённые каналы с соблюдением требований РФ.

---

## REST API

**Назначение:** CRUD-операции и регуляторно значимые транзакции (создание документов, подписание УКЭП, отправка в ЕГИСЗ).

- **Стандарт:** OpenAPI 3.0, JSON
- **Аутентификация:** JWT Bearer Token в заголовке `Authorization: Bearer {token}`
- **Получение токена:** 
  - Врачи/регистраторы: `POST /api/v1/auth/login` (логин + пароль) → JWT
  - Пациенты: вход через ЕСИА или `POST /api/v1/auth/login`
- **Валидация:** обязательная валидация входных данных, структурированные ошибки (RFC 7807)

**Спецификация:** [REST API (OpenAPI)](specs/rest.yaml)

---

## GraphQL API

**Назначение:** агрегирующие запросы для фронтенда (карточка пациента с историей, дашборды).

- **Преимущества:** снижение количества запросов, гибкость выборки
- **Ограничение:** только для **чтения**, критичные операции остаются на REST для трассируемости согласно 911н
- **Авторизация:** RBAC на уровне резолверов, JWT Bearer Token

**Спецификация:** [GraphQL Schema](specs/schema.graphql)

---

## Kafka (Асинхронные события)

**Назначение:** межсервисное взаимодействие, фоновые задачи (уведомления, интеграции, аудит).

- **Формат:** JSON с обязательными полями `eventType`, `eventTimestamp`, `payload`
- **Гарантии доставки:** at-least-once (продюсеры `acks=all`, консюмеры — идемпотентная обработка)
- **Репликация:** replication factor = 3

**Ключевые топики:**

| Топик | Описание | Продюсеры | Консюмеры |
|-------|----------|-----------|-----------|
| `AppointmentScheduled` | Запись на приём | Сервис приёмов | Уведомления, Статистика |
| `DocumentSigned` | Подписание УКЭП | Сервис документов | Интеграция с ЕГИСЗ |
| `EgiszDocumentAccepted` | ЕГИСЗ подтвердил приём | Интеграция с ЕГИСЗ | Аудит, Сервис документов |
| `EgiszDocumentRejected` | ЕГИСЗ отклонил документ | Интеграция с ЕГИСЗ | Уведомления (КМС) |
| `EgiszDocumentPending` | Очередь повторной отправки | Интеграция с ЕГИСЗ | Retry worker |

**Спецификация:** [Kafka Events (AsyncAPI)](specs/kafka.yaml)

---

## Интеграция с ЕГИСЗ

**Назначение:** передача структурированных электронных медицинских документов (СЭМД) в федеральное хранилище ЕГИСЗ/РЭМД.

- **Формат:** CDA Release 2 с российскими справочниками (МКБ-10, ФРМР, ФРМО, СНИЛС)
- **Протокол:** REST API через TLS 1.3, взаимная аутентификация сертификатами

**Процесс отправки:**

1. Врач подписывает документ УКЭП → событие `DocumentSigned`
2. Система валидирует структуру (XSD-схема, коды справочников)
3. Отправка в ЕГИСЗ → событие `EgiszDocumentSent`
4. **При успехе:** GUID от ЕГИСЗ, статус `accepted` → событие `EgiszDocumentAccepted`
5. **При ошибке:** логирование, уведомление врача/КМС → событие `EgiszDocumentRejected`
6. **При недоступности:** документ в топик `EgiszDocumentPending` → retry (1 мин → 5 мин → 15 мин → 1 час)

**Хранение метаданных:** таблица `document_exchange_events` фиксирует все попытки для трассируемости согласно 911н.

---

## Интеграция с ЕСИА

**Назначение:** государственная аутентификация пациентов через Госуслуги.

- **Протокол:** OAuth 2.0 / OpenID Connect
- **Scope:** `openid`, `fullname`, `birthdate`, `snils`, `email`
- **Процесс:** пациент авторизуется через Госуслуги → ЕСИА возвращает подтверждённые данные → автоматическая регистрация/вход

**Преимущества:** единая учётная запись, подтверждённые ПДн от государства.

---

## Федеральные справочники

**Назначение:** синхронизация актуальных справочников для корректного кодирования и обмена с ЕГИСЗ.

| Справочник | Использование | Обновление |
|------------|---------------|------------|
| МКБ-10 | Кодирование диагнозов | Ежегодно |
| ФРМО | Идентификация поликлиники | Еженедельно |
| ФРМР | Сопоставление врача | Ежемесячно |
| ЖНВЛП | Назначение медикаментов | Ежеквартально |

---

## Безопасность интеграций

- TLS 1.3 с взаимной аутентификацией для ЕГИСЗ/ЕСИА
- Секреты в зашифрованном виде (Vault/Kubernetes Secrets)
- Rate limiting и circuit breaker
- Аудит всех запросов в неизменяемый журнал
